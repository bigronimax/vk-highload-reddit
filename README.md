# Курсовая работа по предмету "Проектирование высоконагруженных систем"

## Содержание
### [1. Тема и целевая аудитория](#first)
### [2. Расчет нагрузки](#second)
### [3. Глобальная балансировка нагрузки](#third)
### [4. Локальная балансировка нагрузки](#fourth)
### [5. Логическая схема БД](#fifth)
### [6. Физическая схема БД](#sixth)
### [Список использованных источников](#sources)

<a name="first"></a>
## 1. Тема и целевая аудитория

## Тема
  **Reddit** — это веб-сервис, сочетающий в себе черты форума и социальной сети и основанный на сообществах по интересам.

## Целевая аудитория
  - DAU - 110M. [^2]
  - WAU - 416M. [^2]
  - MAU - 1.21B. [^5]
  - ## Процент трафика по странам
  ![Countries stats](/assets/countries-stat.png) [^1]

## Продуктовые метрики
  - 550 миллионов постов за 2024 год. [^3]
  - 2,72 миллиарда комментариев за 2024 год. [^3]
  - Всего 22+ миллиарда комментариев и постов. [^2]
  - В среднем 40 миллионов поисковых запросов в день за декабрь 2024. [^3]
  - В среднем 9.4 миллиона положительных оценок в день. [^7]
  - 45975 новых сабреддитов каждый месяц. [^4]
  - 1533 новых сабреддитов каждый день. [^4]
  - На момент мая 2022 года было создано 3.5+ миллиона сабреддитов. [^6]
  - Средняя продолжительность сессии - 13.32 минут. [^1]
  - Около 3-4 страниц за визит. [^1]
  - В среднем 4.88 миллиарда визитов за месяц. [^1]
  - Около 515 миллионов зарегистрированных пользователей на сервисе. [^9]

## MVP
  1. Регистрация и авторизация пользователей
  2. Создание и публикация постов 
  3. Создание комментариев к постам
  4. Система оценивания постов/комментариев
  5. Создание тематических сообществ (сабреддиты)
  6. Поиск постов/сообществ
  7. Персонализированная лента рекомендаций

<a name="second"></a>
## 2. Расчет нагрузки 
## Продуктовые метрики

| Метрика | Значение         |
|---------|------------------|
| DAU     | 110 млн [^2]     |
| MAU     | 1.21 млрд [^5]   |

## Среднее количество действий пользователя по действиям из MVP в день

  - Информация касательно регистраций и авторизаций пользователей на сервисе публично не разглашается, поэтому предположу, что пользователь авторизуется в среднем раз в месяц -> в день 1 / 30 = 0.03 раза.
  - Согласно [^3] за 2024 было опубликовано 550 млн постов. Тогда в день -> 550 млн / 365 = 1.507 млн постов. Один пользователь публикует ежедневно 1.507 млн / 110 млн (DAU) = 0.0137 поста.
  -  Согласно [^3] за 2024 было написано 2.72 миллиарда комментариев. Тогда в день -> 2.72 млн / 365 = 7.452 млн постов. Один пользователь публикует ежедневно 1.507 млн / 110 млн (DAU) = 0.068 комментария.
  -  Согласно [^7] пользователи ежедневно оставляют положительные оценки (upvotes) в среднем 9.4 миллиона раз. Сделаю предположение, что количество отрицательных оценок (downvotes) аналогичное. Таким образом, общее количество оценок, оставляеммых пользователями ежедневно = 9.4 млн + 9.4 млн = 18.8 млн. Один пользователь оставляет ежедневно 18.8 млн / 110 млн (DAU) = 0.171 оценки.
  -  Согласно [^4] на сервисе создается около 1533 сабреддитов каждый день. Один пользователь создает ежедневно 1533 / 110 млн (DAU) = 0.00001 сабреддита.
  -  Согласно [^3] за декабрь 2024 было совершенно в среднем 40 миллионов поисковых запросов в день. Один пользователь совершает ежедневно 40 млн / 110 млн (DAU) = 0.36 поисковых запросов.
Информация касательно ленты рекомендаций на сервисе публично не разглашается, поэтому буду отталкиваться от статистики по количеству визитов за месяц и по среднему времени одной сессии. 
  -  Согласно [^1] среднее время продолжительности одной сессии составляет 13.32 минуты и за месяц в среднем насчитывается 4.88 миллиарда визитов на сервис. Примерное количество сессий пользователя за день составляет 4.88 млрд / 1.21 млрд = 4. Согласно [^16] средняя длина текстового поста на reddit составляет 270 символом. Согласно [^11] время, затрачиваемое на прочтение 270 символов составит 50-60 секунд. Учту, что 38% всех постов - посты с изображениями, где пользователи тратят на просмотр от 5 до 10 секунд. Также 21% постов составляют посты с видео, информации о средней продолжительности которых в сети нет, но она не сильно отличается от условных коротких видео в видеохостингах. Таким образом, возьму, что пользователь затрачивает примерно 30 секунд на пост. Один пользователь в день просматривает ((13 * 60 + 60 * 0.32) * 4) секунд / 30 секунд = 107 постов.
  -  Лента реккомендованных постов прогружается по 30 постов за запрос. Учту из вычислений выше, что пользователь в среднем просматривает около 107 постов в день и рассчитаю количество запросов на одного пользователя в день для ленты рекомендаций. На одного пользователя в день уходит около 107 / 30 = 4 запросов для прогрузки ленты.
  -  Согласно [^10] Чуть более половины (50,7%) американцев не читают комментарии к новостям и не оставляют комментарии на новостных сайтах. Сделаю предположение, что только 50% от посещающих сервис заходят во вкладку комментариев. Один пользователь, который заходит в комментарии, в день просматривает 107 / 2 = 54 поста (50% визитов). Предположу, что пользователю нужно посмотреть 5 постов, чтобы зайти во вкалдку комментариев. Таким образом, один пользователь заходит в комментарии 10 раз в день.
  -  Вкладка комментариев прогружается по 30 за запрос без учета вложенных. Учту из вычислений выше, что пользователь в среднем заходит во вкладку около 10 раз в день и рассчитаю количество запросов на одного пользователя в день. Предположу, что пользователь при заходе во вкладку просматривает около 30 комментариев. Таким образом, на одного пользователя в день уходит 10 запросов для прогрузки комментариев, и пользователь просматривает соответственно около 300 комментариев в день.

| Действие пользователя                     | Количество на 1 пользователя в день |
|-------------------------------------------|-------------------------------------|
| Авторизация                               | 0.03                                |
| Публикация поста                          | 0.0137                              |
| Создание комментария                      | 0,068                               |
| Выставление оценки                        | 0.171                               |
| Создание сабреддита                       | 0.00001                             |
| Поисковой запрос                          | 0.36                                |
| Просмотр ленты (посты)                    | 107                                 |
| Просмотр ленты (запросы для постов)       | 4                                   |
| Просмотр ленты (вкладка комментариев)     | 10                                  |
| Просмотр ленты (комментарии)              | 300                                 |
| Просмотр ленты (запросы для комментариев) | 10                                  |

## Средний размер хранилища пользователя

У пользователя можно настроить аватарку, имя, баннер, описание. 
  - Размер аватарки в профиле на reddit составляет 256х256 пикселей. При сжатии с форматом webp предположу, что средний размер аватарки составляет 10 – 30 КБ. Предположу, что только 30% пользователей поставили себе свою фотографию профиля. В таком случае размер аватарки для 1 пользователя в среднем составляет 30 КБ * 0.3 = 9 КБ.
  - Для баннера буду учитывать возможный размер в 150 КБ. Предположу, что только 20% пользователей поставили себе свой баннер. В таком случае размер баннера для 1 пользователя в среднем составляет 150 КБ * 0.2 = 30 КБ.
  - Максимальная длина имени составляет 90 символов, а описания - 200. Возьму в среднем длину имени и описания примерно в 25% от максимального размера: 20 и 50. Так как целевая аудитория сервиса проживает в англоговорящих странах, то приму, что символы латиницы будут весить по 1 байту. Таким образом, имя в среднем будет весить 20 байт, а описание - 50. Таким образом, вес профиля пользователя в среднем составляет 30 КБ + 9 КБ + 20 байт + 50 байт = 0.04 МБ.

Согласно [^8] на сервисе существует 1+ млрд постов на момент 2024 года.
  - Согласно [^7] 38% всех постов имеют изображения, 29% являются текстовыми, 21% с видео, а остальные оставшиеся 12% - со ссылкой. Соответственно среднее количество опубликованных одним пользователем...
  Текстовых постов: (1 млрд * 0.29) / 515 млн = 0.563.
  Постов с изображением: (1 млрд * 0.38) / 515 млн = 0.738.
  Постов с видео: (1 млрд * 0.21) / 515 млн = 0.408.
  Постов с ссылкой: (1 млрд * 0.12) / 515 млн = 0.233
  - Каждый пост обязательно сопровождается заголовком, среднюю длину которого возьму в 25% от максимального размера: 75 символов -> 75 байт.
  - В среднем возьму длину текстового сообщения в 200 символов -> размер поста с текстом составляет (200 байт + 75 байт) * 0.239 = 155 байт.
  - В среднем возьму размер фотографии за 2 МБ -> размер поста с изображением на одного пользователя составляет (2 МБ + 75 байт) * 0.314 = 2 МБ.
  - В среднем возьму видео длиной 30 секунд и размером в 15 МБ разрешением 720p -> размер поста с видео на одного пользователя составляет 15 МБ * 0.174 = 6.12 МБ.
  - В среднем возьму длину URL-адреса в 75 символов -> размер поста с ссылкой составляет (75 байт + 75 байт) * 0.099 = 35 байт.

Согласно [^8] на сервисе существует 16+ млрд комментариев на момент 2024 года.
  - Возьму в среднем длину комментария в 100 символов -> 100 байт. Количество комментариев в среднем на одного пользователя составляет 16 млрд / 515 млн = 31.07. Таким образом, вес комментариев на одного пользователя составит 31.07 * 100 байт = 3.03 КБ.

Каждый сабреддит имеет те же атрибуты, что и профиль пользователя.
  - Среднее количество созданных одним пользователем сабредиттов составляет 3.5 млн / 515 млн = 0.007. Таким образом, вес сабреддита на одного пользователя составит (150 КБ * 2 + 20 байт + 50 байт) * 0.007 = 0.002 МБ.

Каждый голос имеет в базе данных user_id (8 байт), post_id (8 байт), upvote/downvote (1 байт).
  - Так как нет в публичном доступе информации об общем количестве оценок, то предположу, что на каждого пользователя приходится в среднем по 500 оценок. Размер одной оценки в базе данных составляет 17 байт -> вес всех оценок в среднем на одного пользователя составляет 500 * 17 байт = 8.3 КБ.

Согласно [^17] в среднем каждый пользователь делает 10 подписок на какие-либо сабреддиты. Каждая подписка имеет в базе данных user_id (8 байт), subreddit_id (8 байт). Размер одной подписки составляет 16 байт -> вес подписок в среднем на одного пользователя составляет 160 байт.

| Тип данных                          | Размер, МБ     | Количество |
|-------------------------------------|----------------|------------|
| Профиль                             | 0.04           | 1          |
| Текстовые посты                     | 155 * 1024^-2  | 0.563      |
| Посты с изображением                | 2              | 0.738      |
| Посты с видео                       | 6.12           | 0.408      |
| Посты с ссылкой                     | 35 * 1024^-2   | 0.233      |
| Комментариии                        | 3.03 * 1024^-1 | 31.07      |
| Сабреддит                           | 0,002          | 0.007      |
| Оценки                              | 8.3 * 1024^-1  | 500        |
| Подписки                            | 160 * 1024^-2  | 10         |
| Итого                               | 8,173          |            |

## Технические метрики
### Размер хранилища
  - Согласно [^9] на момент 2025 года будет около 515 миллионов зарегистрированных пользователей на сервисе. Таким образом, вес всех профилей будет составлять 0.04 МБ * 515 млн = 20 ТБ.
  - Вес текстовых постов на одного пользователя составляет 155 * 1024^-2 МБ. Общий вес текстовых постов -> 155 * 1024^-2 МБ * 515 млн = 0.0726 ТБ.
  - Вес постов с изображением на одного пользователя составляет 2 МБ. Общий вес постов с изображением -> 2 МБ * 515 млн = 982.28 ТБ.
  - Вес постов с видео на одного пользователя составляет 6.12 МБ. Общий вес постов с видео -> 6.12 МБ * 515 млн = 3005.79 ТБ.
  - Вес постов с ссылкой на одного пользователя составляет 35 * 1024^-2 МБ. Общий вес постов с ссылкой -> 35 * 1024^-2 МБ * 515 млн = 0.016 ТБ.
  - Вес комментариев на одного пользователя составляет 3.03 * 1024^-1 МБ. Общий вес комментариев -> 3.03 * 1024^-1 * 515 млн = 1.45 ТБ.
  - Вес оценок на одного пользователя составляет 8.3 * 1024^-1 МБ. Общий вес оценок -> 8.3 * 1024^-1 * 515 млн = 4 ТБ.
  - Вес подписки на одного пользователя составляет 160 * 1024^-2 МБ. Общий вес оценок -> 160 * 1024^-2 * 515 млн = 0.08 ТБ.
  - Согласно [^4] На момент 2022 года было создано около 3.5 миллионов сабреддитов. Каждый месяц создается около 45975 сабреддитов. Таким образом, предположим, что линейно общее количество к 2025 году будет равно 45975 * 12 * 3 + 3.5 млн = 5 155 100. Общий вес всех сабреддитов будет составлять 0.003 МБ * 5 155 100 = 0.015 ТБ.

| Тип данных                          | Размер, ТБ     |
|-------------------------------------|----------------|
| Профиль                             | 20             |
| Текстовые посты                     | 0.0726         |
| Посты с изображением                | 982.28         |
| Посты с видео                       | 3005.79        |
| Посты с ссылкой                     | 0.016          |
| Комментариии                        | 1.45           |
| Сабреддит                           | 0.015          |
| Оценки                              | 4              |
| Подписки                            | 0.08           |
| Итого                               | 4013.7         |

## RPS
Формула для расчета среднего RPS: (количество запросов в день от одного пользователя * DAU) / 86400 секунд
Пиковый же RPS буду брать в 3 раза больше среднего

  - Авторизация: (0,03 * 110 000 000) / 86400 = 38
  - Публикация поста: (0.0137 * 110 000 000) / 86400 = 17
  - Создание комментария: (0,068 * 110 000 000) / 86400 = 87
  - Выставление оценки: (0.171 * 110 000 000) / 86400 = 218
  - Создание сабреддита: (0.00001 * 110 000 000) / 86400 = 0.01
  - Поисковой запрос: (0,36 * 110 000 000) / 86400 = 458
  - Просмотр ленты (посты): (4 * 110 000 000) / 86400 = 5093
  - Просмотр ленты (комментарии): (10 * 110 000 000) / 86400 = 12731.5

| Тип запроса                  | Средний RPS | Пиковый RPS |
|------------------------------|-------------|-------------|
| Авторизация                  | 38          | 114         |
| Публикация поста             | 17          | 51          |
| Создание комментария         | 87          | 261         |
| Выставление оценки           | 218         | 654         |
| Создание сабреддита          | 0.01        | 0.03        |
| Поисковой запрос             | 458         | 1374        |
| Просмотр ленты (посты)       | 5093        | 15279       |
| Просмотр ленты (комментарии) | 12732       | 38196       |
| Итого                        | 18643       | 55929       |

## Сетевой трафик
Формула для расчета среднего сетевого трафика: трафик на действие * средний RPS

Трафик на действие:
1. Авторизация: 40 байт (email + пароль).
2. Публикация поста: 275 * 1024^-2 * 0.29 + 2.71 * 0.38 + 15 * 0.21 + 150 * 1024^-2 * 0.12 = 4.18 МБ.
3. Создание комментария: 0.1 * 1024^-1 МБ.
4. Выставление оценки: 0.02 * 1024^-1 МБ.
5. Создание сабреддита: 1 МБ.
6. Поисковой запрос: 7 постов при выдаче, но без видео -> (4.18 МБ - 0.21 * 15) * 7 = 7.21 МБ.
7. Обновление ленты (посты): 4.18 МБ * 30 = 117 МБ (30 постов).
8. Обновление ленты (комментарии): 0.1 * 1024^-1 МБ * 30 = 3 * 1024^-1 МБ (30 комментариев).

Потребление:
1. Авторизация
   - Среднее: 40 байт * 38 = 1.5 КБ/с = 0.00001 Гбит/с.
   - Пиковое: 0.00001 Гбит/с * 3 = 0.00003 Гбит/с.
2. Публикация поста
   - Среднее: 4.18 МБ * 17 = 72765.44 КБ/с = 0.56 Гбит/с.
   - Пиковое: 0.56 Гбит/с * 3 = 1.68 Гбит/с.
3. Создание комментария
   - Среднее: 0.1 КБ * 87 = 8.7 КБ/с = 0.00007 Гбит/с.
   - Пиковое: 0.00007 Гбит/с * 3 = 0.00021 Гбит/с. 
4. Выставление оценки
   - Среднее: 0.02 КБ * 218 = 4.36 КБ/с = 0.00003 Гбит/с.
   - Пиковое: 0.00003 Гбит/с * 3 = 0.00009 Гбит/с.
5. Создание сабреддита
   - Среднее: 1 МБ * 0.01 = 10.24 КБ/с = 0.00008 Гбит/с.
   - Пиковое: 0.00008 Гбит/с * 3 = 0.00024 Гбит/с.
6. Поисковой запрос
   - Среднее: 7.21 МБ * 458 = 3302 МБ/с = 25.8 Гбит/с.
   - Пиковое: 25.8 Гбит/с * 3 = 77.4 Гбит/с.
7. Обновление ленты (посты)
   - Среднее: 117 МБ * 5093 = 595881 МБ/с = 4655.3 Гбит/с.
   - Пиковое: 4655.3 Гбит/с * 3 = 13965.9 Гбит/с.
8. Обновление ленты (комментарии)
   - Среднее: 3 КБ * 12732 = 38196 КБ/с = 0.29 Гбит/с.
   - Пиковое: 0.29 Гбит/с * 3 = 0.87 Гбит/с.

| Действие                         | Трафик на действие | Среднее потребление, Гбит/с | Пиковое потребление, Гбит/с | 
|----------------------------------|--------------------|-----------------------------|-----------------------------|
| Авторизация                      | 40 байт            | 0.00001                     | 0.00003                     | 
| Публикация поста                 | 4.18 МБ            | 0.56                        | 1.68                        | 
| Создание комментария             | 0.1 * 1024^-1 МБ   | 0.00007                     | 0.00021                     | 
| Выставление оценки               | 0.02 * 1024^-1 МБ  | 0.00003                     | 0.00009                     |
| Создание сабреддита              | 1 МБ               | 0.00008                     | 0.00024                     | 
| Поисковой запрос                 | 7.21 МБ            | 25.8                        | 77.4                        |
| Обновление ленты (посты)         | 117 МБ             | 4655.3                      | 13965.9                     | 
| Обновление ленты (комментарии)   | 3 * 1024^-1 МБ     | 0.29                        | 0.87                        | 
| Итого                            |                    | 4682                        | 14046                       |

<a name="third"></a>
## 3. Глобальная балансировка нагрузки
## Разбиение по доменам
- www.reddit.com — основной домен
- api.reddit.com — API для разработки
- static.reddit.com - раздача статики

## Обоснование расположения ДЦ
Согласно [^12] распределение трафика по земному шару и количества пользователей происходит следующим образом:
США - 42.95% (194.8 млн); Великобритания - 5.46% (33.2 млн); Индия - 5.18% (26.8 млн); Канада - 5.01% (23.9 млн); Австралия - 3.54% (13.5 млн); Германия - 3.49% (22.5 млн); Франция - 2.97% (12.9 млн); Бразилия - 2.62% (22.5 млн), Нидерланды - 2.55% (6.4 млн), Швеция - 2.05% (5.7 млн)... (дальше по списку идут преимущественно европейские страны).

При разбиении стран по глобальным регионам получается:

| Регион                | Страны                                                 | Процент трафика |
|-----------------------|--------------------------------------------------------|-----------------|
| Северная Америка      | США, Канада                                            | 47.96%          |
| Европа                | Великобритания, Германия, Франция, Нидерланды, Швеция  | 16,52%          |
| Азия                  | Индия                                                  | 5.18%           |
| Океания               | Австралия                                              | 3.54%           |
| Южная Америка         | Бразилия                                               | 2.62%           |

Таким образом, основная целевая аудитория находится в США, которой нужно уделить особое внимание, а также Европе, общий процент трафика в которой переваливает за 20, если учитывать каждую входящую страну.

![USA stats](/assets/USA-stat.png) [^13]

Согласно [^13] наибольший процент заселенности на территориии США у штатов: 
- Калифорния, юго-западное побережье (39 664 800, 11.66%)
- Техас, юг (31 853 800, 9.36%)
- Флорида, юго-восточное побережье (23 839 600, 7%)
- Нью-Йорк, северо-восток (19 997 100, 5.88%)
- Пенсильвания, северо-восток (13 139 800, 3.86%)

По карте видно, что население центра и запада США без учета Калифорнии и Техаса мало в сравнении с густозаселенным востоком. Также согласно [^14] Reddit активно пользуется серверами от Amazon (AWS) и Google Cloud. Буду подбирать расположения датацентров с учетом вышеперечисленных серверов Amazon согласно [^15].

![Data-centers](/assets/data-centers.png)
На основе распределения трафика по странам, населенности штатов США и расположения серверов AWS я выбрал следующие города для ДЦ:
1. Запад США:
   - Сейлем, штат Орегон
   - Лос-Анджелес, штат Калифорния
2. Центр США:
   - Денвер, штат Колорадо
   - Остин, штат Техас
3. Восток США + Канада:
   - Оттава, Канада
   - Чикаго, штат Иллинойс
   - Нью-Йорк, штат Нью-Йорк
   - Ричмонд, штат Вирджиния
4. Европа:
   - Лондон, Великобритания
   - Франкфурт, Германия
   - Милан, Италия
   - Стокгольм, Швеция
   - Мадрид, Испания
   - Стамбул, Турция
5. Азия:
   - Нью-Дели, Индия
6. Океания:
   - Сидней, Австралия
7. Южная Америка:
   - Бразилиа, Бразилия

## Расчет распределение запросов из секции "Расчет нагрузки" по типам запросов по датацентрам

| Действие                       | Северная Америка (47.96%) | Европа (34.12%)  | Азия (7.6%)    | Океания (6.09%)  | Южная Америка (4.23%) |
|--------------------------------|---------------------------|------------------|----------------|------------------|-----------------------|
| Авторизация                    | 54                        | 39               | 8.7            | 6.9              | 4.8                   |
| Публикация поста               | 24                        | 17.4             | 3.9            | 3.12             | 2.1                   |
| Создание комментария           | 126                       | 90               | 19.8           | 15.9             | 11.04                 |
| Выставление оценки             | 315                       | 222.9            | 49.8           | 39.9             | 27.6                  |
| Создание сабреддита            | 0.015                     | 0.0102           | 0.0024         | 0.0018           | 0.0012                |
| Поисковой запрос               | 660                       | 468.9            | 104.4          | 83.7             | 58.2                  |
| Обновление ленты (посты)       | 7329                      | 5213.1           | 1161.3         | 930.6            | 646.2                 |
| Обновление ленты (комментарии) | 18318                     | 13032.6          | 2902.8         | 2326.2           | 1615.8                |
| Итого                          | 26826                     | 19084            | 4251           | 3406             | 2366                  |

В среднем на один датацентр будет приходиться по 3000 RPS. 

## Схема DNS балансировки
GeoDNS - для построения оптимальных маршрутов до ближайших датацентров на основе географического расположения с учетом распределения сервиса в США, Европе и других континентам.

## Схема Anycast балансировки
BGP Anycast балансировка - для определения ближайшего датацентра в рамках высоконагруженных регионов (США, Европа) на основе сетевой топологии, где множеству датацентров назначается один и тот же IP-адрес.

<a name="fourth"></a>
## 4. Локальная балансировка нагрузки

## Nginx
Прием входящего трафика будет осуществляться через сервера Nginx. Он отличается своей надежностью, сопоставимой с надежностью самой железки и долгой работой без перезапусков, но тем не менее для отказоустойчивости возьму два сервера Nginx. Для обеспечения непосредственной отказоустойчивости буду использовать keepalived по протоколу VRRP, по которому у обоих серверов будет один IP-адрес, но один будет работать, а второй будет в резерве. Если один сервер откажет, то второй практически моментально проснется и будет брать весь трафик на себя. Nginx также будет обеспечивать SSL терминацию, облегчая нагрузку внутренних серверов, кэширование статики и сжатие трафика через gzip. 

## Kubernetes
В каждом датацентре развернут кластер Kubernetes. Внутри кластера сервер Nginx выступает в роли Ingress-контроллера и L7-балансировщика. При изменении нагрузки он сам перераспределяет ее по имеющимся компонентам, а при отказе отдельных компонентов Kubernetes оперативно их перезапускает. Масштабирование происходит с помощью технологии auto-scaling, которая осуществляет подстройку под текущую нагрузку. Для отслеживания состояний компонентов будут использоваться health-check запросы в рамках kubernetes.

![Kubernetes](/assets/kubernetes.png)

В рамках кластера Kubernetes есть три основных сущности: pod - инстанс микросервиса, service - знает всю информацию о всех подах, которые к нему относятся (ip-адреса, количество активных подов, какие именно поды активны), Ingress-контроллер - L7-балансировщик, который распределяет весь трафик между микросервисами. При взаимодействии одного пода из одного микросервиса с другим происходит следующий процесс: под бежит сразу в Ingress-контроллер, Ingress видит в передаваемом трафике домен микросервиса, с которым поду нужно провзаимодейстовать. Ingress знает, к кому нужно обращаться, и просит у нужного service IP-адрес пода, куда нужно перенаправить трафик. 

<a name="fifth"></a>
## 5. Логическая схема БД

![Database](/assets/database.jpg)

## Описание таблиц
| Таблица | Описание                                                                                                                                                             |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Session | Данные о сессиях пользователей: токен, дата истечения токена (expired_at). |
| Users | Данные о пользователях: email, хэш пароля, никнейм, описание, аватар и банер в виде изображений, дата регистрации (created_at) и последнего обновления (updated_at). |
| Image | Данные о всех изображениях в виде uuid. Используется для связи с PostImages, аватарками и баннерами.                                                                 |
| Comment | Данные о комментариях: текст, рейтинг, дата публикации (created_at) и последнего обновления (updated_at). Связывается с постом и пользователем и родительским комментарием.   |
| Post | Данные о постах: заголовок, тип поста, рейтинг, количество комментариев, дата публикации (created_at) и последнего обновления (updated_at). Связывается с создателем и сабреддитом.                       |
| PostText | Данные о текстовых постах: текст, дата публикации (created_at) и последнего обновления (updated_at). Связывается с постом.                                          |
| PostVideo | Данные о постах с видео: url видео, дата публикации (created_at) и последнего обновления (updated_at). Связывается с постом.                                       |
| PostImages | Данные о постах с изображениями: дата публикации (created_at) и последнего обновления (updated_at). Связывается с постом и с изображениями.                       |
| PostLink | Данные о постах с ссылкой: ссылка, дата публикации (created_at) и последнего обновления (updated_at). Связывается с постом.                                         |
| PostVote | Данные о голосах у постов: тип голоса, дата оценки (created_at) и последнего обновления (updated_at). Связывается с постом и пользователем.                         |
| CommentVote | Данные о голосах у комментариев: тип голоса, дата оценки (created_at) и последнего обновления (updated_at). Связывается с комментарием и пользователем.          |
| Subreddit | Данные о сабреддитах: название, описание, аватар и банер в виде изображений, количество подписок, дата создания (created_at) и последнего обновления (updated_at). Связывается с создателем.   |
| Subrscription | Данные о подписках. Связывается с пользователем и сабреддитом. |

## Размеры данных
| Таблица | Расчет размера строки (поля) | Размер строки | Всего строк | Размер таблицы |
|---------|------------------------------|---------------|-------------|----------------|
| Session | 16 (id) + 16 (user_id) + 40 (token) + 4 (expired_at) | 76 байт | 515 млн. | 37 ГБ |
| Users | 16 (id) + 16 (avatar_id) + 16 (banner_id) + 90 (nickname) + 200 (description) + 32 (email) + 64 (password) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 443 байт | 515 млн. | 213 ГБ |
| Image | 16 (id) + 16 (uuid) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 41 байт | +-500 млн. | 19 ГБ |
| Comment | 16 (id) + 16 (creator_id) + 16 (post_id) + 16 (parent_comment_id) + 100 (content) + 16 (rating) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 189 байт | 16 млрд. | 2.8 ТБ |
| Post | 16 (id) + 16 (creator_id) + 16 (subbreddit_id) + 300 (title) + 5 (post_type) + 16 (rating) + 16 (comment_count) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 394 байт | 1 млрд. | 367 ГБ |
| PostText | 16 (id) + 16 (post_id) + 200 (content) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 241 байт | 290 млн. | 65.1 ГБ |
| PostVideo | 16 (id) + 16 (post_id) + 75 (video_url) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 116 байт | 210 млн. | 23 ГБ |
| PostImages | 16 (id) + 16 (post_id) + 16 (image_id) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 57 байт | 380 млн. | 20.2 ГБ |
| PostLink | 16 (id) + 16 (post_id) + 75 (link) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 116 байт | 120 млн. | 13 ГБ |
| PostVote | 16 (id) + 16 (user_id) + 16 (post_id) + 1 (is_voteup) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 58 байт | 9.4 млн. | 0.5 ГБ |
| CommentVote | 16 (id) + 16 (user_id) + 16 (post_id) + 1 (is_voteup) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 58 байт | 9.4 млн. | 0.5 ГБ |
| Subreddit | 16 (id) + 16 (creator_id) + 16 (avatar_id) + 16 (banner_id) + 21 (name) + 500 (description) + 16 (subscriptions) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 610 байт | 5.155 млн. | 2.93 ГБ |
| Subscription | 16 (id) + 16 (user_id) + 16 (subreddit_id) + 1 (is_deleted) + 4 (created_at) + 4 (updated_at) | 57 байт | 5.15 млрд. | 273 ГБ |

## Расчет нагрузки на чтение/запись

| Тип запроса                  | Средний RPS | Пиковый RPS | Запросов в базу данных на один Request                                           | Средний QPS (Чтение) | Пиковый QPS (Чтение) | Средний QPS (Запись) | Пиковый QPS (Запись) | 
|------------------------------|-------------|-------------|----------------------------------------------------------------------------------|----------------------|-------------------------|----------------------|----------------------|
| Авторизация                  | 38          | 114         | 2 (select по email, select token)                                                | 38                   | 114                     | 38                   | 114                  |
| Публикация поста             | 17          | 51          | 3 (select subreddit, insert post, insert images)                                 | 17                   | 51                      | 34                   | 102                  |
| Создание комментария         | 87          | 261         | 2 (select post, insert comment)                                                  | 87                   | 261                     | 87                   | 261                  |
| Выставление оценки           | 218         | 654         | 1 (insert comment/post vote)                                                     | -                    | -                       | 218                  | 654                  |
| Создание сабреддита          | 0.01        | 0.03        | 1 (insert subreddit)                                                             | -                    | -                       | 0.01                 | 0.03                 |
| Поисковой запрос             | 458         | 1374        | 2 (select id, select post)                                                       | 916                  | 2748                    | -                    | -                    |
| Просмотр ленты (посты)       | 5093        | 15279       | 4 (select id, select post, select subreddit, select vote)                        | 20372                | 61116                   | -                    | -                    |
| Просмотр ленты (комментарии) | 12732       | 38196       | 5 (select id, select comment, select users, select vote, select parent_comments) | 93215                | 279645                  | -                    | -                    |
| Итого                        | 18643       | 55929       |                                                                                  | 114645               | 343936                  | 377.01               | 1131.03              |

## Требования к консистентности
- При удалении пользователя, сабреддита, поста, комментария каскадно удаляются связанные данные (подписки, голоса, посты, комментарии)
- created_at, uploaded_at заполняются автоматически
- post_type всегда один и соответствует своей таблице: text -> PostText, video -> PostVideo, link -> PostLink, image -> PostImages
- Комментарий не должен быть родителем сам себе
- Пользователь не может подписываться на один и тот же сабреддит дважды
- Пользователь не может оценивать одинаково пост/комментарий дважды

<a name="sixth"></a>
## 6. Физическая схема БД

![Db](/assets/db.png)

### Индексы

| Таблица | Индексы                | Пояснение |
|---------|------------------------|-----------|
| Post    | idx_posts_by_subreddit (subreddit_id, created_at, is_deleted), idx_posts_feed (created_at, is_deleted) | Быстрая выборка постов по сабреддиту c сортировкой по дате, лента свежих постов |
| Comment	| idx_comments_by_post (post_id, rating, is_deleted), idx_comments_by_user (user_id, created_at, is_deleted) | Быстрая выборка комментариев к постам с сортировкой по рейтингу, быстрая выборка комментариев пользователя с сортировкой по дате |
| Subscription | idx_subreddits_by_user (user_id, subreddit_id) | Быстрое получение списка сообществ пользователя, на которые он подписан |

### Денормализация

| Таблица | Поля для денормализации | Источник данных | Цель |
|---------|-------------------------|-----------------|------|
| Users | avatar_url, banner_url | Image | Быстрый доступ к картинкам пользователя, избавляемся от лишних JOIN |
| Subreddit | avatar_url, banner_url | Image | Быстрый доступ к картинкам пользователя, избавляемся от лишних JOIN |
| Subreddit | subscriptions | Subscription | Быстрое получение количества подписок у сообщества, избавляемся от лишнего COUNT |
| Post | creator_nickname, creator_avatar_url | User | Быстрый доступ к данным автора поста, избавляемся от лишних JOIN |
| Post | subreddit_name, subreddit_avatar_url | Subreddit | Быстрый доступ к данным сабреддита у поста, избавляемся от лишних JOIN |
| Post | content, video_url, image_urls | PostText, PostVideo, PostImages, PostLink | Быстрый доступ к контенту поста без дополнительных таблиц, избавляемся от лишних JOIN |
| Post | comment_count | Comment | Быстрое получение количества комментариев у поста, избавляемся от лишнего COUNT |
| Post | rating | PostVote | Быстрое получение рейтинга у поста, избавляемся от лишнего COUNT |
| Comment | creator_nickname, creator_avatar_url | User | Быстрый доступ к данным автора комментария, избавляемся от лишних JOIN |
| Comment | rating | CommentVote | Быстрое получение рейтинга у комментария, избавляемся от лишнего COUNT |

### Выбор СУБД (потаблично)

| Таблица | СУБД | Пояснение |
|---------|------|-----------|
| Users | PostgreSQL | Транзакции, безопасность, уникальные данные |
| Session | Redis | Быстрый доступ с минимальной задержкой |
| Post | Cassandra | Высокая нагрузка на чтение и запись |
| Comment | Cassandra | Высокая нагрузка на чтение и запись |
| PostVote | Cassandra | Частые записи без delete и update |
| CommentVote | Cassandra | Частые записи без delete и update |
| Subscription | PostgreSQL | Низкая нагрузка на чтение и запись |
| Subreddit | PostgreSQL | Низкая нагрузка на чтение и запись, уникальные данные |

### Шардирование и резервирование СУБД (потаблично)

| Таблица | Шардирование | Резервирование | Пояснение |
|---------|--------------|----------------|-----------|
| Users | Горизонтальное разделение user_id | Master-Slave репликация в PostgreSQL для обеспечения отказоустойчивости (1 мастер, 3 реплики) | Много данных, данные критичны для сервиса |
| Session | Шардирование в Redis по session_id с использованием Redis Cluster | Redis Master-Replica для отказоустойчивости | Быстрый доступ с минимальными задержками |
| Post | В Cassandra шардирование работает по partition key - по subreddit_id. Данные автоматически распределяются равномерно по кластеру и все посты одного сабреддита будут находится в одном шарде	| Настройка Replication Factor = 3 для отказоустойчивости | Высокая нагрузка на чтение и запись требуют горизонтального масштабирования и репликации |
| Comment | В Cassandra шардирование работает по partition key - по post_id. Данные автоматически распределяются равномерно по кластеру и все комментарии одного поста будут находится в одном шарде | Настройка Replication Factor = 3 для отказоустойчивости	| Высокая нагрузка на чтение и запись требуют горизонтального масштабирования и репликации |
| PostVote | В Cassandra шардирование работает по partition key - по post_id. Данные автоматически распределяются равномерно по кластеру и все оценки одного поста будут находится в одном шарде	| Настройка Replication Factor = 3 для отказоустойчивости | Высокая нагрузка на запись и большое количество записей требуют горизонтального масштабирования и репликации |
| CommentVote | В Cassandra шардирование работает по partition key - по comment_id. Данные автоматически распределяются равномерно по кластеру и все оценки одного комментария будут находится в одном шарде	| Настройка Replication Factor = 3 для отказоустойчивости | Высокая нагрузка на запись и большое количество записей требуют горизонтального масштабирования и репликации |
| Subscription | Нагрузка низкая, шардирование не требуется | Master-Slave репликация в PostgreSQL для обеспечения отказоустойчивости (1 мастер, 1 реплика) | Небольшая нагрузка на запись не требуют горизонтального масштабирования |
| Subreddit	| Нагрузка низкая, шардирование не требуется | Master-Slave репликация в PostgreSQL для обеспечения отказоустойчивости (1 мастер, 2 реплики) | Небольшая нагрузка не требует горизонтального масштабирования |

<a name="sources"></a>
## Список использованных источников

[^1]: [reddit.com Web Traffic Statistics](https://www.semrush.com/website/reddit.com/overview/)
[^2]: [Reddit by the numbers](https://redditinc.com/press)
[^3]: [Reddit User and Growth Stats](https://backlinko.com/reddit-users)
[^4]: [How Many Subreddits Are There? (Subreddit Statistics)](https://www.businessdasher.com/how-many-subreddits-are-there/)
[^5]: [Reddit Statistics 2025 (Top Picks)](https://www.demandsage.com/reddit-statistics/)
[^6]: [New subreddits by month](https://frontpagemetrics.com/month/)
[^7]: [Reddit Statistics 2025: Traffic, Users, and More](https://sqmagazine.co.uk/reddit-statistics/)
[^8]: [Reddit could use this strategy to ‘monetize aggressively’ following its IPO](https://www.marketwatch.com/story/reddit-could-use-this-strategy-to-monetize-aggressively-following-its-ipo-2e1c91da)
[^9]: [How Many Users Does Reddit Have? (2025)](https://electroiq.com/stats/how-many-users-does-reddit-have/)
[^10]: [Survey of Commenters and Comment Readers](https://mediaengagement.org/research/survey-of-commenters-and-comment-readers/)
[^11]: [Content Marketing: What We Learned About Optimal Word Count for Posts, Blogs & Articles](https://ventropymedia.com/content-marketing-what-we-learned-about-optimal-word-count-for-posts-blogs-articles/)
[^12]: [Reddit Users by Country 2025](https://worldpopulationreview.com/country-rankings/reddit-users-by-country)
[^13]: [US States - Ranking by Population 2025](https://worldpopulationreview.com/states)
[^14]: [Reddit uses AWS and Google Cloud, plans to spend at least $385m on cloud by September 2026](https://www.datacenterdynamics.com/en/news/reddit-uses-aws-and-google-cloud-plans-to-spend-at-least-385m-on-cloud-by-september-2026/)
[^15]: [AWS Global Infrastructure](https://aws.amazon.com/about-aws/global-infrastructure/)
[^16]: [Tensorflow Reddit](https://www.tensorflow.org/datasets/catalog/reddit)
[^17]: [Navigating the massive world of reddit: Using backbone networks to map user interests in social media](https://arxiv.org/pdf/1312.3387)
